**Agent Task: Implement Phase 1 of `plan.md` for Stills Diffuse Scattering Pipeline**

**Overall Goal for Agent (Phase 1):** To implement the logic for processing individual stills to produce indexed crystal models, reflection lists with partialities, and comprehensive pixel masks ready for diffuse data extraction.

**Checklist Usage Instructions for Agent:** (Same as Phase 0)

1.  **Copy this entire checklist into your working memory or a dedicated scratchpad area.**
2.  **Context Priming:** Before starting a new phase or major module, carefully read all "Context Priming" points for that section.
3.  **Sequential Execution:** Address checklist items in the order presented.
4.  **Update State:** Use `[ ] Open`, `[P] In Progress`, `[D] Done`, `[B] Blocked`. Add a note for `[B]`.
5.  **Record Details:** File paths, decisions, sub-task breakdowns.
6.  **Iterative Review:** Periodically re-read completed sections and notes.
7.  **Save State:** Ensure this checklist with current states and notes is saved if pausing.

---

**Phase 1: Per-Still Geometry, Indexing, and Initial Masking**

| Item ID | Task Description                                                                | State | Details/Notes/Path                                                                                                                                                             |
| :------ | :------------------------------------------------------------------------------ | :---- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1.A** | **Context Priming (Phase 1)**                                                   | `[ ]` |                                                                                                                                                                              |
| 1.A.1   | Re-read `plan.md` Module 1.S.1: Per-Still Crystallographic Processing           | `[ ]` |                                                                                                                                                                              |
| 1.A.2   | Re-read `plan.md` Module 1.S.2: Static and Dynamic Pixel Mask Generation        | `[ ]` |                                                                                                                                                                              |
| 1.A.3   | Re-read `plan.md` Module 1.S.3: Combined Per-Still Bragg and Pixel Mask Gen     | `[ ]` |                                                                                                                                                                              |
| 1.A.4   | Review `src/diffusepipe/types/types_IDL.md` (esp. `DIALSStillsProcessConfig`, `ComponentInputFiles`, `OperationOutcome`). | `[ ]` |                                                                                                                                                                              |
| 1.A.5   | Review relevant adapters from Phase 0 (DIALSStillsProcessAdapter, DIALSGenerateMaskAdapter, DXTBXIOAdapter). | `[ ]` |                                                                                                                                                                              |
| 1.A.6   | Understand Goal: Implement modules for per-still DIALS processing, static/dynamic pixel masking, and Bragg/total mask generation. | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.B** | **Module 1.S.1: Per-Still Crystallographic Processing and Model Validation**    | `[ ]` | *Note: Core logic is in `DIALSStillsProcessAdapter` (Phase 0.C.1). This section focuses on its usage context within a conceptual component and its higher-level testing.*          |
| **1.B.idl** | **Review/Confirm Conceptual Interface for a "StillProcessorAndValidatorComponent"** | `[ ]` | **Purpose:** This component orchestrates DIALS processing AND subsequent validation. <br>Input: `image_path: str`, `config: StillsPipelineConfig` (to access `DIALSStillsProcessConfig` and validation tolerances), `base_experiment_path?: str`, `external_pdb_path?: str`. <br>Output: `(Experiment_dials_i?, Reflections_dials_i?, validation_passed: bool, validation_metrics: dict, success_bool, logs_str)` or an `OperationOutcome`. <br>Behavior: Uses `DIALSStillsProcessAdapter`, then performs geometric and PDB consistency checks. <br>Path (Conceptual): `src/diffusepipe/crystallography/still_processing_and_validation.py` |
| 1.B.1   | Implementation of `StillProcessorAndValidatorComponent` (or equivalent logic) | `[ ]` | Path: `src/diffusepipe/crystallography/still_processing_and_validation.py` (New or renamed file) |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.B.V** | **Sub-Module 1.S.1.Validation: Geometric Model Consistency Checks Implementation** | `[ ]` | In `src/diffusepipe/crystallography/still_processing_and_validation.py` (or a dedicated `model_validator.py` called by it)                                                      |
| 1.B.V.1 | Implement PDB Consistency Check logic                                         | `[ ]` |                                                                                                                                                                              |
|         |   - Input: `Experiment_dials_i.crystal`, `external_pdb_path`, tolerances from config. | `[ ]` |                                                                                                                                                                              |
|         |   - Compare unit cell parameters (lengths, angles).                           | `[ ]` |                                                                                                                                                                              |
|         |   - Compare crystal orientation (A or U matrix).                              | `[ ]` |                                                                                                                                                                              |
| 1.B.V.2 | Implement Q-Vector Consistency Check logic                                  | `[ ]` |                                                                                                                                                                              |
|         |   - Input: `Experiment_dials_i`, `Reflections_dials_i`, `q_consistency_tolerance_angstrom_inv`. | `[ ]` |                                                                                                                                                                              |
|         |   - Loop subset of reflections: get `s1` vector, pixel coords (e.g., `xyzobs.px.value`). | `[ ]` |                                                                                                                                                                              |
|         |   - Calculate `q_model` (from `s1`, `s0`) and `q_observed` (from pixel coords and geometry). | `[ ]` |                                                                                                                                                                              |
|         |   - Compute `|Î”q| = |q_model - q_observed|` and check against tolerance.     | `[ ]` |                                                                                                                                                                              |
| 1.B.V.3 | Implement Diagnostic Plot Generation for validation                           | `[ ]` | Similar to `consistency_checker.py` plots (q-diff histogram, q-scatter, heatmap). Save to working dir.                                                                       |
|         |                                                                                 |       |                                                                                                                                                                              |
| 1.B.2   | **Integration Test for StillProcessorAndValidatorComponent**           | `[ ]` | Path: `tests/crystallography/test_still_processor.py`                                                                                                                          |
| 1.B.2.a | Test Case: `test_process_single_still_successfully`                             | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: Minimal CBF, `DIALSStillsProcessConfig`, Adapter instance          | `[ ]` | Test Data: `tests/data/minimal_still.cbf`, `tests/data/minimal_stills_process.phil`                                                                                              |
|         |   - Execution: Call the component/function wrapping `adapter.process_still(...)` | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Success status, valid `Experiment` & `reflection_table`       | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: `"partiality"` column exists and has floats                   | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Assert validation_passed is True, Assert validation_metrics are reasonable. | `[ ]` |                                                                                                                                                                              |
| 1.B.2.b | Test Case: `test_process_still_indexing_failure`                                | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: Image/config known to fail indexing                                  | `[ ]` | Test Data: `tests/data/unindexable_still.cbf` or specific PHIL.                                                                                                                |
|         |   - Execution: Call the component/function wrapping `adapter.process_still(...)` | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Failure status or `DIALSError` handled                        | `[ ]` |                                                                                                                                                                              |
| 1.B.2.c | Test Case: `test_validation_pdb_mismatch_cell`                          | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: DIALS output with cell params differing from mock PDB outside tolerance. | `[ ]` |                                                                                                                                                                              |
|         |   - Execution: Call component.                                              | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Assert `validation_passed` is False, appropriate status/message. | `[ ]` |                                                                                                                                                                              |
| 1.B.2.d | Test Case: `test_validation_q_consistency_failure`                      | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: Mock DIALS output where `q_bragg` and `q_pixel_recalc` differ significantly. | `[ ]` |                                                                                                                                                                              |
|         |   - Execution: Call component.                                              | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Assert `validation_passed` is False, appropriate status/message. | `[ ]` |                                                                                                                                                                              |
| 1.B.2.e | Test Case: `test_validation_all_pass`                                     | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: DIALS output and mock PDB that are consistent within tolerances. | `[ ]` |                                                                                                                                                                              |
|         |   - Execution: Call component.                                              | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Assert `validation_passed` is True.                       | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.C** | **Module 1.S.2: Static and Dynamic Pixel Mask Generation**                      | `[ ]` |                                                                                                                                                                              |
| **1.C.idl** | **Define/Review Conceptual IDL for `PixelMaskGenerator`**                     | `[ ]` | **Purpose:** Define interface for generating `Mask_pixel`. <br>Path for IDL thoughts (e.g. in comments of Python file): `src/diffusepipe/masking/pixel_mask_generator.py` <br>Structs: `StaticMaskParams { beamstop?: Circle/Rect, untrusted_rects?: list<Rect>, untrusted_panels?: list<int> }`, `DynamicMaskParams { hot_pixel_thresh?: float }`. <br>Method: `generate_combined_pixel_mask(detector: Detector, static_params: StaticMaskParams, representative_images: list[ImageSet], dynamic_params: DynamicMaskParams) -> tuple[flex.bool, ...]`. <br>Errors: `MaskGenerationError`. |
| 1.C.1   | Implement `generate_static_mask` function                                     | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py` (Based on 1.C.idl)                                                                                                        |
| 1.C.1.a |   - `detector.get_trusted_range_mask()` application                             | `[ ]` |                                                                                                                                                                              |
| 1.C.1.b |   - Beamstop mask (circular/rectangular from `StaticMaskParams`)                | `[ ]` |                                                                                                                                                                              |
| 1.C.1.c |   - Untrusted panel/rectangle masks (from `StaticMaskParams`)                   | `[ ]` |                                                                                                                                                                              |
| 1.C.1.d |   - Combine static masks using `flex.bool` logic                                | `[ ]` |                                                                                                                                                                              |
| 1.C.2   | Implement `generate_dynamic_mask` function                                    | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py` (Based on 1.C.idl)                                                                                                        |
| 1.C.2.a |   - Iterate `representative_images` (list of `ImageSet`)                        | `[ ]` |                                                                                                                                                                              |
| 1.C.2.b |   - Identify anomalous pixels (vectorized) using `DynamicMaskParams`            | `[ ]` |                                                                                                                                                                              |
| 1.C.2.c |   - Combine per-image dynamic masks (logical OR)                                | `[ ]` |                                                                                                                                                                              |
| 1.C.3   | Implement `generate_combined_pixel_mask` function                             | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py`. Combines static & dynamic. (Based on 1.C.idl)                                                                            |
| 1.C.4   | **Unit Tests for Pixel Mask Generation**                                        | `[ ]` | Path: `tests/masking/test_pixel_mask_generator.py`                                                                                                                             |
| 1.C.4.a |   - Test `generate_static_mask` with mock `Detector` & `StaticMaskParams`       | `[ ]` |                                                                                                                                                                              |
| 1.C.4.b |   - Test `generate_dynamic_mask` with mock `ImageSet` data & `DynamicMaskParams`| `[ ]` |                                                                                                                                                                              |
| 1.C.4.c |   - Test `generate_combined_pixel_mask` for correct logical combination         | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.D** | **Module 1.S.3: Combined Per-Still Bragg and Pixel Mask Generation**            | `[ ]` |                                                                                                                                                                              |
| **1.D.idl** | **Define/Review Conceptual IDL for `BraggMaskGenerator`**                     | `[ ]` | **Purpose:** Define interface for `BraggMask_2D_raw_i` and `Mask_total_2D_i`. <br>Path for IDL thoughts: `src/diffusepipe/masking/bragg_mask_generator.py` <br>Method (Option A): `generate_bragg_mask_from_spots(experiment: Experiment, reflections: reflection_table, adapter: DIALSGenerateMaskAdapter, config: dict) -> tuple[flex.bool, ...]`. <br>Method (Option B): `generate_bragg_mask_from_shoeboxes(reflections: reflection_table, detector: Detector) -> tuple[flex.bool, ...]`. <br>Method (Combine): `get_total_mask_for_still(bragg_mask: tuple[flex.bool,...], global_pixel_mask: tuple[flex.bool,...]) -> tuple[flex.bool,...]`. <br>Errors: `BraggMaskError`. |
| 1.D.1   | Implement Option A: `generate_bragg_mask_from_spots`                          | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`. Calls `DIALSGenerateMaskAdapter`. (Based on 1.D.idl)                                                                      |
| 1.D.2   | Implement Option B: `generate_bragg_mask_from_shoeboxes`                      | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`. (Based on 1.D.idl)                                                                                                     |
| 1.D.2.a |     - Initialize per-panel `flex.bool` masks to `False`.                        | `[ ]` |                                                                                                                                                                              |
| 1.D.2.b |     - Iterate shoeboxes from `reflection_table`.                                  | `[ ]` |                                                                                                                                                                              |
| 1.D.2.c |     - Identify `MaskCode.Foreground` / `MaskCode.Strong` pixels.                  | `[ ]` |                                                                                                                                                                              |
| 1.D.2.d |     - Project 3D mask to 2D panel coordinates & update panel mask.              | `[ ]` |                                                                                                                                                                              |
| 1.D.3   | Implement `get_total_mask_for_still` logic                                      | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`. (Based on 1.D.idl)                                                                                                     |
| 1.D.4   | **Unit Tests for Bragg Mask Generation**                                        | `[ ]` | Path: `tests/masking/test_bragg_mask_generator.py`                                                                                                                             |
| 1.D.4.a |   - Test Option A: Mock `Experiment`, `reflection_table`, mock adapter.         | `[ ]` |                                                                                                                                                                              |
| 1.D.4.b |   - Test Option B: Create mock `reflection_table` with `Shoebox` objects.       | `[ ]` |                                                                                                                                                                              |
| 1.D.4.c |   - Test `get_total_mask_for_still`: Provide sample masks & verify logic.       | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.E** | **Phase 1 Review & Next Steps**                                                 | `[ ]` |                                                                                                                                                                              |
| 1.E.1   | Self-Review: All Phase 1 items addressed? IDLs defined/reviewed?                | `[ ]` |                                                                                                                                                                              |
| 1.E.2   | Context Refresh: Re-read `plan.md` sections for Phase 2 (Data Extraction).      | `[ ]` |                                                                                                                                                                              |
| 1.E.3   | Decision: Proceed to Phase 2 Checklist.                                         | `[ ]` |                                                                                                                                                                              |

---

**Key Changes in this Phase 1 Checklist:**

1.  **IDL Definition/Review Steps (`.idl` suffixed items):** Added explicit steps (e.g., `1.B.idl`, `1.C.idl`, `1.D.idl`) to define or review the conceptual interface *before* Python implementation of the core logic for each module.
    *   These "IDL thoughts" are primarily for clarifying the contract of the Python functions/classes being developed for that module. They might live as comments in the Python files or in the agent's scratchpad initially.
    *   They ensure that the inputs, outputs, core behavior, and error conditions are considered upfront.
2.  **Specific File Paths:** Suggested more specific Python file names for the new modules (e.g., `pixel_mask_generator.py`, `bragg_mask_generator.py`) to better organize the masking logic.
3.  **Configuration Details:** Added notes on where configuration parameters (e.g., for static masks, dynamic mask thresholds) would come from or how they might be structured as inputs to the functions.
4.  **Clarity on "Component":** For 1.S.1, clarified that the "StillProcessorComponent" is more of a conceptual wrapper or a simple orchestrating function that uses the already-developed `DIALSStillsProcessAdapter`. No new complex IDL is needed if the adapter's interface is sufficient.

