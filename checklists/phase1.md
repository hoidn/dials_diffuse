**Agent Task: Implement Phase 1 of `plan.md` for Stills Diffuse Scattering Pipeline**

**Overall Goal for Agent (Phase 1):** To implement the logic for processing individual stills to produce indexed crystal models, reflection lists with partialities, and comprehensive pixel masks ready for diffuse data extraction.

**Checklist Usage Instructions for Agent:** (Same as Phase 0)

1.  **Copy this entire checklist into your working memory or a dedicated scratchpad area.**
2.  **Context Priming:** Before starting a new phase or major module, carefully read all "Context Priming" points for that section.
3.  **Sequential Execution:** Address checklist items in the order presented.
4.  **Update State:** Use `[ ] Open`, `[P] In Progress`, `[D] Done`, `[B] Blocked`. Add a note for `[B]`.
5.  **Record Details:** File paths, decisions, sub-task breakdowns.
6.  **Iterative Review:** Periodically re-read completed sections and notes.
7.  **Save State:** Ensure this checklist with current states and notes is saved if pausing.

---

**Phase 1: Per-Still Geometry, Indexing, and Initial Masking**

| Item ID | Task Description                                                                | State | Details/Notes/Path                                                                                                                                                             |
| :------ | :------------------------------------------------------------------------------ | :---- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1.A** | **Context Priming (Phase 1)**                                                   | `[ ]` |                                                                                                                                                                              |
| 1.A.1   | Re-read `plan.md` Module 1.S.1: Per-Still Crystallographic Processing           | `[ ]` |                                                                                                                                                                              |
| 1.A.2   | Re-read `plan.md` Module 1.S.2: Static and Dynamic Pixel Mask Generation        | `[ ]` |                                                                                                                                                                              |
| 1.A.3   | Re-read `plan.md` Module 1.S.3: Combined Per-Still Bragg and Pixel Mask Gen     | `[ ]` |                                                                                                                                                                              |
| 1.A.4   | Review `src/diffusepipe/types/types_IDL.md` (esp. `DIALSStillsProcessConfig` etc.) | `[ ]` |                                                                                                                                                                              |
| 1.A.5   | Review relevant adapters from Phase 0 (DIALSStillsProcessAdapter, etc.)         | `[ ]` |                                                                                                                                                                              |
| 1.A.6   | Understand Goal: Process stills for models, reflections, and masks.             | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.B** | **Module 1.S.1: Per-Still Crystallographic Processing**                         | `[ ]` | *Note: Core logic is in `DIALSStillsProcessAdapter` (0.C.1). This is about its usage context & higher-level testing.*                                                           |
| 1.B.1   | Define Interface (Conceptual - covered by adapter's design)                     | `[D]` | Confirmed: Adapter interface from 0.C.1.a is appropriate.                                                                                                                      |
| 1.B.2   | Implementation (Handled by `DIALSStillsProcessAdapter`)                         | `[D]` | Confirmed: Adapter from 0.C.1.b-f implements the logic.                                                                                                                        |
| 1.B.3   | **Integration Test for `DIALSStillsProcessAdapter` usage**                      | `[ ]` | Path: `tests/crystallography/test_still_processor.py` (or similar)                                                                                                             |
| 1.B.3.a | Test Case: `test_process_single_still_successfully`                             | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: Minimal CBF, `DIALSStillsProcessConfig`, Adapter instance          | `[ ]` | Test Data: `tests/data/minimal_still.cbf`, `tests/data/minimal_stills_process.phil`                                                                                              |
|         |   - Execution: Call `adapter.process_still(...)`                                | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Success flag, valid `Experiment` & `reflection_table`         | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: `"partiality"` column exists and has floats                   | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: (Optional) DIALS output files created in temp dir             | `[ ]` |                                                                                                                                                                              |
| 1.B.3.b | Test Case: `test_process_still_indexing_failure`                                | `[ ]` |                                                                                                                                                                              |
|         |   - Setup: Image/config known to fail indexing                                  | `[ ]` | Test Data: `tests/data/unindexable_still.cbf` or specific PHIL.                                                                                                                |
|         |   - Execution: Call `adapter.process_still(...)`                                | `[ ]` |                                                                                                                                                                              |
|         |   - Verification: Success flag false or `DIALSError` handled                    | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.C** | **Module 1.S.2: Static and Dynamic Pixel Mask Generation**                      | `[ ]` | Path for implementation: `src/diffusepipe/masking/pixel_mask_generator.py` (New file, more specific than generic `mask_generator.py`)                                         |
| 1.C.1   | Define Python function signatures for mask generation                           | `[ ]` | E.g., `generate_static_mask(...)`, `generate_dynamic_mask(...)`, `generate_combined_pixel_mask(...)`.                                                                         |
| 1.C.2   | **Implement Static Mask Generation logic**                                      | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py`                                                                                                                           |
| 1.C.2.a |   - `detector.get_trusted_range_mask()` application                             | `[ ]` |                                                                                                                                                                              |
| 1.C.2.b |   - Beamstop mask (circular/rectangular from config)                            | `[ ]` | Config: `beamstop_config: Optional[dict]` e.g. `{'type': 'circle', 'panel_idx':0, 'x':100,'y':100,'r':10}`                                                                   |
| 1.C.2.c |   - Untrusted panel/rectangle masks (from config)                               | `[ ]` | Config: `untrusted_rects: Optional[list[dict]]`, `untrusted_panels: Optional[list[int]]`                                                                                       |
| 1.C.2.d |   - Combine static masks using `flex.bool` logic                                | `[ ]` |                                                                                                                                                                              |
| 1.C.3   | **Implement Dynamic Mask Generation logic**                                     | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py`                                                                                                                           |
| 1.C.3.a |   - Iterate `representative_images` (list of `ImageSet`)                        | `[ ]` |                                                                                                                                                                              |
| 1.C.3.b |   - Identify anomalous pixels (negative, hot) per image (vectorized)            | `[ ]` | Config: `hot_pixel_threshold: float`, `negative_value_threshold: float` (e.g. 0 or slightly negative)                                                                          |
| 1.C.3.c |   - Combine per-image dynamic masks (logical OR)                                | `[ ]` |                                                                                                                                                                              |
| 1.C.4   | **Implement Combined Pixel Mask Generation (`Mask_pixel`)**                     | `[ ]` | In `src/diffusepipe/masking/pixel_mask_generator.py`. Combines static & dynamic.                                                                                               |
| 1.C.5   | **Unit Tests for Pixel Mask Generation**                                        | `[ ]` | Path: `tests/masking/test_pixel_mask_generator.py`                                                                                                                             |
| 1.C.5.a |   - Test `generate_static_mask` with mock `Detector` & configs                  | `[ ]` | Verify correct pixels flagged.                                                                                                                                                 |
| 1.C.5.b |   - Test `generate_dynamic_mask` with mock `ImageSet` data (flex arrays)        | `[ ]` | Verify known hot/cold pixels flagged.                                                                                                                                          |
| 1.C.5.c |   - Test `generate_combined_pixel_mask` for correct logical combination         | `[ ]` |                                                                                                                                                                              |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.D** | **Module 1.S.3: Combined Per-Still Bragg and Pixel Mask Generation**            | `[ ]` | Path for implementation: `src/diffusepipe/masking/bragg_mask_generator.py` (New file)                                                                                          |
| 1.D.1   | Define Python function signatures for Bragg mask generation & combination       | `[ ]` | E.g., `generate_bragg_mask_from_spots(...)`, `generate_bragg_mask_from_shoeboxes(...)`, `get_total_mask_for_still(...)`.                                                       |
| 1.D.2   | **Implement Option A: `generate_bragg_mask_from_spots`**                        | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`. Calls `DIALSGenerateMaskAdapter`.                                                                                          |
| 1.D.3   | **Implement Option B: `generate_bragg_mask_from_shoeboxes`**                    | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`.                                                                                                                          |
| 1.D.3.a |     - Initialize per-panel `flex.bool` masks to `False`.                        | `[ ]` |                                                                                                                                                                              |
| 1.D.3.b |     - Iterate shoeboxes from `reflection_table`.                                  | `[ ]` |                                                                                                                                                                              |
| 1.D.3.c |     - Identify `MaskCode.Foreground` / `MaskCode.Strong` pixels.                  | `[ ]` |                                                                                                                                                                              |
| 1.D.3.d |     - Project 3D mask to 2D panel coordinates & update panel mask.              | `[ ]` | Refer to `DIALS_Python_API_Reference.md` A.5 Ex6.                                                                                                                              |
| 1.D.4   | **Implement `get_total_mask_for_still` logic**                                  | `[ ]` | In `src/diffusepipe/masking/bragg_mask_generator.py`. Combines `BraggMask_2D_raw_i` and `Mask_pixel` (logical AND NOT).                                                        |
| 1.D.5   | **Unit Tests for Bragg Mask Generation**                                        | `[ ]` | Path: `tests/masking/test_bragg_mask_generator.py`                                                                                                                             |
| 1.D.5.a |   - Test Option A: Mock `Experiment`, `reflection_table`, mock adapter.         | `[ ]` | Verify adapter call and output handling.                                                                                                                                       |
| 1.D.5.b |   - Test Option B: Create mock `reflection_table` with `Shoebox` objects.       | `[ ]` | Verify correct 2D mask from projected shoebox foregrounds.                                                                                                                     |
| 1.D.5.c |   - Test `get_total_mask_for_still`: Provide sample `BraggMask_2D_raw_i` & `Mask_pixel`. | `[ ]` | Verify correct boolean combination.                                                                                                                                            |
|         |                                                                                 |       |                                                                                                                                                                              |
| **1.E** | **Phase 1 Review & Next Steps**                                                 | `[ ]` |                                                                                                                                                                              |
| 1.E.1   | Self-Review: All Phase 1 items addressed? Paths/decisions noted?                | `[ ]` |                                                                                                                                                                              |
| 1.E.2   | Context Refresh: Re-read `plan.md` sections for Phase 2 (Data Extraction).      | `[ ]` |                                                                                                                                                                              |
| 1.E.3   | Decision: Proceed to Phase 2 Checklist.                                         | `[ ]` |                                                                                                                                                                              |
