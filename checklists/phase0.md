**Agent Task: Implement Phase 0 of `plan.md` for Stills Diffuse Scattering Pipeline**

**Overall Goal for Agent (Phase 0):** To set up the project structure, define core utilities/adapters that will be used by Phase 1 modules, and establish testing infrastructure.

**Checklist Usage Instructions for Agent:**

1.  **Copy this entire checklist into your working memory or a dedicated scratchpad area.**
2.  **Context Priming:** Before starting a new phase or major module, carefully read all "Context Priming" points for that section.
3.  **Sequential Execution:** Address checklist items in the order presented, unless an item explicitly states it can be done in parallel or depends on a later item being drafted first (e.g., an IDL).
4.  **Update State:** As you work on an item, change its state field:
    *   `[ ] Open` -> `[P] In Progress` when you start.
    *   `[P] In Progress` -> `[D] Done` when completed successfully.
    *   `[P] In Progress` -> `[B] Blocked` if you encounter a blocker. Add a note explaining the blocker.
5.  **Record Details:**
    *   If a step requires creating a new file, add the **full path** to the created file in the "Details/Notes/Path" column.
    *   If a decision is made, note it briefly.
    *   If a sub-task needs to be broken down, add sub-bullets with their own states.
6.  **Iterative Review:** Periodically re-read completed sections and notes.
7.  **Save State:** Ensure this checklist with current states and notes is saved if pausing.

---

**Phase 0: Foundational Setup, Principles, and Adapters**

| Item ID | Task Description                                                                | State | Details/Notes/Path                                                                                                                                                              |
| :------ | :------------------------------------------------------------------------------ | :---- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **0.A** | **Context Priming (Phase 0)**                                                   | `[ ]` |                                                                                                                                                                               |
| 0.A.1   | Re-read `plan.md` Section 0.0: Testing Principles and Conventions             | `[ ]` |                                                                                                                                                                               |
| 0.A.2   | Re-read `plan.md` Section 0.6: Adapter Layer strategy                         | `[ ]` |                                                                                                                                                                               |
| 0.A.3   | Re-read `plan.md` Section 0.X: Intermediate QC Checkpoints                      | `[ ]` | Understand *types* of QC planned.                                                                                                                                               |
| 0.A.4   | Review `docs/01_IDL_GUIDELINES.md`                                              | `[ ]` |                                                                                                                                                                               |
| 0.A.5   | Review `docs/02_IMPLEMENTATION_RULES.md`                                        | `[ ]` |                                                                                                                                                                               |
| 0.A.6   | Review `docs/03_PROJECT_RULES.md`                                               | `[ ]` |                                                                                                                                                                               |
| 0.A.7   | Review `docs/ARCHITECTURE/types.md`                                             | `[ ]` |                                                                                                                                                                               |
| 0.A.8   | Review `src/diffusepipe/types/types_IDL.md`                                     | `[ ]` |                                                                                                                                                                               |
| 0.A.9   | Understand Goal: Setup project, core utilities/adapters, testing infra.       | `[ ]` |                                                                                                                                                                               |
|         |                                                                                 |       |                                                                                                                                                                               |
| **0.B** | **Project Structure & Core Utilities**                                          | `[ ]` |                                                                                                                                                                               |
| 0.B.1   | **Establish Directory Structure (as per `docs/03_PROJECT_RULES.md` & `plan.md`)** | `[ ]` |                                                                                                                                                                               |
| 0.B.1.a | Create `src/diffusepipe/` and `src/diffusepipe/__init__.py`                     | `[D]` | Path: `src/diffusepipe/` - Exists with __init__.py                                                                                                                              |
| 0.B.1.b | Create `src/diffusepipe/adapters/` & `__init__.py`                              | `[D]` | Path: `src/diffusepipe/adapters/` - Exists with multiple DIALS adapters                                                                                                        |
| 0.B.1.c | Create `src/diffusepipe/constants.py` (if needed)                               | `[D]` | Path: `src/diffusepipe/constants.py` - Exists                                                                                                                                   |
| 0.B.1.d | Create `src/diffusepipe/exceptions.py`                                          | `[D]` | Path: `src/diffusepipe/exceptions.py` - Exists                                                                                                                                  |
| 0.B.1.e | Create `src/diffusepipe/logging_config.py`                                      | `[D]` | Path: `src/diffusepipe/logging_config.py` - Exists                                                                                                                              |
| 0.B.1.f | Create `src/diffusepipe/utils/` & `__init__.py`                                 | `[D]` | Path: `src/diffusepipe/utils/` - Exists with cbf_utils.py                                                                                                                       |
| 0.B.1.g | Verify `src/diffusepipe/types/` exists                                          | `[D]` | Path: `src/diffusepipe/types/` - Exists with types_IDL.py                                                                                                                       |
| 0.B.1.h | Verify `src/diffusepipe/orchestration/` exists                                  | `[D]` | Path: `src/diffusepipe/orchestration/` - Exists with IDL files                                                                                                                  |
| 0.B.1.i | Verify `src/diffusepipe/extraction/` exists                                     | `[D]` | Path: `src/diffusepipe/extraction/` - Exists with data_extractor.py                                                                                                            |
| 0.B.1.j | Verify `src/diffusepipe/diagnostics/` exists                                    | `[D]` | Path: `src/diffusepipe/diagnostics/` - Exists with q_calculator.py                                                                                                             |
| 0.B.1.k | Create `src/diffusepipe/masking/` & `__init__.py`                               | `[D]` | Path: `src/diffusepipe/masking/` - Exists with mask generators                                                                                                                  |
| 0.B.1.l | Create `src/diffusepipe/crystallography/` & `__init__.py`                       | `[D]` | Path: `src/diffusepipe/crystallography/` - Exists with still processing modules                                                                                                 |
| 0.B.1.m | Create `src/diffusepipe/scaling/` & `__init__.py`                               | `[D]` | Path: `src/diffusepipe/scaling/` - Exists                                                                                                                                       |
| 0.B.1.n | Create `src/diffusepipe/merging/` & `__init__.py`                               | `[D]` | Path: `src/diffusepipe/merging/` - Exists                                                                                                                                       |
| 0.B.1.o | Create `tests/` & `__init__.py`                                                 | `[D]` | Path: `tests/` - Exists with comprehensive test structure                                                                                                                       |
| 0.B.1.p | Create `tests/conftest.py`                                                      | `[D]` | Path: `tests/conftest.py` - Exists                                                                                                                                              |
| 0.B.1.q | Create `tests/data/`                                                            | `[D]` | Path: `tests/data/` - Exists                                                                                                                                                    |
| 0.B.1.r | Create mirrored test subdirectories (e.g., `tests/adapters/`, etc.)           | `[D]` | Exists: adapters/, crystallography/, diagnostics/, extraction/, masking/, etc.                                                                                                  |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.B.2   | **Define Core Project Exceptions (`src/diffusepipe/exceptions.py`)**            | `[ ]` | Path: `src/diffusepipe/exceptions.py`                                                                                                                                           |
| 0.B.2.a | Define `PipelineError(Exception)`                                               | `[ ]` |                                                                                                                                                                               |
| 0.B.2.b | Define `ConfigurationError(PipelineError)`                                      | `[ ]` |                                                                                                                                                                               |
| 0.B.2.c | Define `DIALSError(PipelineError)`                                              | `[ ]` |                                                                                                                                                                               |
| 0.B.2.d | Define `FileSystemError(PipelineError)`                                         | `[ ]` |                                                                                                                                                                               |
| 0.B.2.e | Define `DataValidationError(PipelineError)`                                     | `[ ]` |                                                                                                                                                                               |
| 0.B.2.f | Define `NotImplementedYetError(PipelineError)`                                  | `[ ]` |                                                                                                                                                                               |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.B.3   | **Setup Basic Logging Configuration (`src/diffusepipe/logging_config.py`)**     | `[ ]` | Path: `src/diffusepipe/logging_config.py`                                                                                                                                       |
| 0.B.3.a | Implement function for basic console/file logging setup                       | `[ ]` | Decision: Use `logging.basicConfig` initially for simplicity.                                                                                                                   |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.B.4   | **Implement Testing Framework Setup (`tests/conftest.py`)**                     | `[ ]` | Path: `tests/conftest.py`                                                                                                                                                       |
| 0.B.4.a | Add `tmp_path` fixture (standard pytest) or equivalent for temp dirs.         | `[ ]` | Note: `tmp_path` is a built-in pytest fixture.                                                                                                                                  |
|         |                                                                                 |       |                                                                                                                                                                               |
| **0.C** | **Adapter Layer Implementation (Core Adapters for Phase 1)**                    | `[ ]` |                                                                                                                                                                               |
| 0.C.A   | **Context Priming (Adapters)**                                                  | `[ ]` |                                                                                                                                                                               |
| 0.C.A.1 | Review `plan.md` Section 0.6 (Adapter Layer strategy)                         | `[ ]` |                                                                                                                                                                               |
| 0.C.A.2 | Confirm understanding: Adapters encapsulate DIALS/CCTBX calls.                  | `[ ]` |                                                                                                                                                                               |
| 0.C.A.3 | Confirm understanding: Adapters handle config translation (e.g., to PHIL).      | `[ ]` |                                                                                                                                                                               |
| 0.C.A.4 | Confirm understanding: Adapters raise project-specific exceptions.              | `[ ]` |                                                                                                                                                                               |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.C.1   | **Adapter for `dials.stills_process.Processor` (Module 1.S.1)**               | `[ ]` |                                                                                                                                                                               |
| **0.C.1.idl** | **Define/Review Conceptual IDL for `DIALSStillsProcessAdapter`**            | `[ ]` | **Purpose:** Clarify inputs, outputs, core behavior, and error conditions *before Python coding*. Not a formal project IDL file unless decided, but a clear interface spec. <br>Input: `image_path: str`, `config: DIALSStillsProcessConfig`, `base_expt_path?: str`. <br>Output: `(Experiment?, reflection_table?, success_bool, logs_str)`. <br>Behavior: Wraps `dials.stills_process.Processor`. Handles PHIL, import, process, results. <br>Errors: `DIALSImportError`, `DIALSProcessError`, `PartialityMissingError`. |
| 0.C.1.a | Implement `DIALSStillsProcessAdapter` class structure                         | `[ ]` | Path: `src/diffusepipe/adapters/dials_stills_process_adapter.py` (Based on 0.C.1.idl)                                                                                           |
| 0.C.1.b | Implement `__init__` method                                                     | `[ ]` |                                                                                                                                                                               |
| 0.C.1.c | Implement `process_still` method core logic                                     | `[ ]` | Incl. PHIL generation, `Processor` instantiation, `do_import`, `process_experiments`.                                                                                           |
| 0.C.1.d | Implement result extraction & partiality check in `process_still`             | `[ ]` |                                                                                                                                                                               |
| 0.C.1.e | Implement error handling (DIALS exceptions -> `DIALSError`) in `process_still`  | `[ ]` |                                                                                                                                                                               |
| 0.C.1.f | Write Unit Tests for `DIALSStillsProcessAdapter`                                | `[ ]` | Path: `tests/adapters/test_dials_stills_process_adapter.py`                                                                                                                     |
| 0.C.1.g |   - Test: successful processing (mocked `Processor`)                              | `[ ]` |                                                                                                                                                                               |
| 0.C.1.h |   - Test: PHIL parameter generation                                                 | `[ ]` |                                                                                                                                                                               |
| 0.C.1.i |   - Test: `do_import` failure handling                                              | `[ ]` |                                                                                                                                                                               |
| 0.C.1.j |   - Test: `process_experiments` failure handling                                    | `[ ]` |                                                                                                                                                                               |
| 0.C.1.k |   - Test: result extraction and partiality check                                    | `[ ]` |                                                                                                                                                                               |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.C.2   | **Adapter for `dials.generate_mask` (Module 1.S.3, Option A)**                | `[ ]` |                                                                                                                                                                               |
| **0.C.2.idl** | **Define/Review Conceptual IDL for `DIALSGenerateMaskAdapter`**             | `[ ]` | **Purpose:** Clarify interface before Python coding. <br>Input: `experiment: Experiment`, `reflections: reflection_table`, `mask_generation_params: dict`. <br>Output: `tuple[flex.bool]` (mask per panel), `success_bool`, `logs_str`. <br>Behavior: Wraps `dials.util.masking.generate_mask` or `Script` execution. <br>Errors: `DIALSMaskGenError`. |
| 0.C.2.a | Implement `DIALSGenerateMaskAdapter` class structure                          | `[ ]` | Path: `src/diffusepipe/adapters/dials_generate_mask_adapter.py` (Based on 0.C.2.idl)                                                                                          |
| 0.C.2.b | Implement `generate_bragg_mask` method                                          | `[ ]` | Calls `dials.util.masking.generate_mask` or `Script` prog.                                                                                                                      |
| 0.C.2.c | Write Unit Tests for `DIALSGenerateMaskAdapter`                                 | `[ ]` | Path: `tests/adapters/test_dials_generate_mask_adapter.py`                                                                                                                      |
| 0.C.2.d |   - Test: successful mask generation (mocked `generate_mask`)                       | `[ ]` |                                                                                                                                                                               |
| 0.C.2.e |   - Test: parameter translation                                                     | `[ ]` |                                                                                                                                                                               |
|         |                                                                                 |       |                                                                                                                                                                               |
| 0.C.3   | **Adapter for DXTBX/flex I/O (General Utility)**                              | `[ ]` | Path: `src/diffusepipe/adapters/dxtbx_i_o_adapter.py` (Renamed for clarity)                                                                                                     |
| **0.C.3.idl** | **Define/Review Conceptual IDL for `DXTBXIOAdapter`**                       | `[ ]` | **Purpose:** Standardize file I/O for DIALS objects. <br>Methods: `load_experiment_list(path) -> ExperimentList`, `load_reflection_table(path) -> reflection_table`, `save_experiment_list(expts, path)`, `save_reflection_table(refls, path)`. <br>Errors: `FileReadError`, `FileWriteError`. |
| 0.C.3.a | Implement `load_experiment_list(expt_path)`                                     | `[ ]` | Wraps `ExperimentListFactory.from_json_file`. (Based on 0.C.3.idl)                                                                                                              |
| 0.C.3.b | Implement `load_reflection_table(refl_path)`                                    | `[ ]` | Wraps `flex.reflection_table.from_file`.                                                                                                                                        |
| 0.C.3.c | Implement `save_reflection_table(table, path)`                                  | `[ ]` |                                                                                                                                                                               |
| 0.C.3.d | Implement `save_experiment_list(experiments, path)`                             | `[ ]` |                                                                                                                                                                               |
| 0.C.3.e | Write Unit Tests for DXTBX/flex I/O adapter                                     | `[ ]` | Path: `tests/adapters/test_dxtbx_i_o_adapter.py`. Test loading/saving valid/invalid files.                                                                                      |
|         |                                                                                 |       |                                                                                                                                                                               |
| **0.D** | **Phase 0 Review & Next Steps**                                                 | `[ ]` |                                                                                                                                                                               |
| 0.D.1   | Self-Review: All Phase 0 items addressed? IDLs defined/reviewed?                | `[ ]` |                                                                                                                                                                               |
| 0.D.2   | Context Refresh: Re-read `plan.md` sections for Phase 1.                      | `[ ]` |                                                                                                                                                                               |
| 0.D.3   | Decision: Proceed to Phase 1 Checklist.                                         | `[ ]` |                                                                                                                                                                               |

